name: Windows

on: [push]

env:
  Path: "C:/Program Files/Meson;C:/Program Files/LLVM/bin;C:/Program Files/Git/bin;C:/Program Files/CMake/bin;C:/ProgramData/Chocolatey/bin;C:/Windows/system32;C:/Windows;C:/Program Files (x86)/Windows Kits/10/Windows Performance Toolkit"

jobs:
  windows-msvc:
    name: Windows - MSVC
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: 'recursive'

    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Install Meson
      run: |
        Invoke-WebRequest -Uri https://github.com/mesonbuild/meson/releases/download/0.57.1/meson-0.57.1.1-64.msi -OutFile meson.msi
        msiexec /i meson.msi /passive /qn

    - name: Configure Meson
      run: |
        meson setup build --buildtype=release

    - name: Build
      run: |
        meson compile -C build

    - name: Test
      run: meson test -C build

    - name: Store compiled program
      uses: actions/upload-artifact@v2
      with:
        name: cloudflare-ddns-windows
        path: ${{runner.workspace}}/cloudflare-ddns/build/cloudflare-ddns

  windows-clang-cl:
    name: Windows - clang-cl
    runs-on: windows-latest
    env:
      CC: clang-cl
      CXX: clang-cl

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: 'recursive'

    - name: Install Clang
      run: |
        Invoke-WebRequest -Uri https://github.com/llvm/llvm-project/releases/download/llvmorg-11.1.0/LLVM-11.1.0-win64.exe -OutFile llvm.exe
        7z x llvm.exe -y -o"C:/Program Files/LLVM"

    - name: Install Meson
      run: |
        Invoke-WebRequest -Uri https://github.com/mesonbuild/meson/releases/download/0.57.1/meson-0.57.1.1-64.msi -OutFile meson.msi
        msiexec /i meson.msi /passive /qn

    - name: Configure Meson
      run: |
        meson setup build --buildtype=release

    - name: Build
      run: |
        meson compile -C build

    - name: Test
      run: |
        meson test -C build

    - name: Store compiled program
      uses: actions/upload-artifact@v2
      with:
        name: cloudflare-ddns-windows-clang
        path: ${{runner.workspace}}/cloudflare-ddns/build/cloudflare-ddns
